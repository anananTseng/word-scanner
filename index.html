<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿå­—æƒææ©Ÿ V6 (é€šç”¨ç‰ˆ)</title>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; text-align: center; background-color: #f8f9fa; padding: 10px; margin: 0; }
        
        /* ç‹€æ…‹æ¢ */
        #system-status { background: #e2e3e5; color: #383d41; padding: 5px; font-size: 12px; margin-bottom: 10px; border-radius: 4px; }

        /* 1. æœ€å·¨å¤§çš„æ”¹è®Šï¼šç”¨ Label ç•¶ä½œæŒ‰éˆ• */
        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
            max-width: 350px;
            margin-top: 10px;
        }

        /* æŠŠåŸæœ¬é†œé†œçš„ input è®Šé€æ˜ï¼Œè“‹åœ¨æŒ‰éˆ•ä¸Šé¢ */
        .upload-btn-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0; /* é€æ˜ */
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        /* æŒ‰éˆ•å¤–è§€ */
        .btn-style {
            border: 3px dashed #007bff;
            color: #007bff;
            background-color: white;
            padding: 30px 20px;
            border-radius: 15px;
            font-size: 22px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }

        /* æŒ‰ä¸‹å»çš„åæ‡‰ */
        .upload-btn-wrapper:active .btn-style {
            background-color: #e3f2fd;
            border-style: solid;
        }

        /* åœ–ç‰‡é è¦½ */
        #preview-box {
            margin-top: 20px;
            display: none;
            border: 2px solid #28a745;
            padding: 5px;
            border-radius: 10px;
            background: white;
        }
        #preview-img { width: 100%; max-width: 300px; border-radius: 5px; }

        /* å€™é¸å­— */
        #candidates-area { display: none; margin-top: 15px; padding: 10px; background: #fff; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .c-btn {
            display: inline-block; width: 50px; height: 50px; line-height: 50px; margin: 5px;
            background: #f0f0f0; border: 2px solid #007bff; border-radius: 8px;
            font-size: 24px; color: #333; cursor: pointer;
        }

        /* çµæœå€ */
        #result-area { display: none; margin-top: 15px; padding: 20px; background: #fff3cd; border-radius: 15px; border: 2px solid #ffecb5; }
        .big-text { font-size: 80px; color: #dc3545; margin: 10px 0; font-weight: bold; }
        
        button.action { font-size: 16px; padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; color: white; cursor: pointer; }
        .btn-speak { background: #28a745; }
        .btn-dict { background: #17a2b8; }
        .btn-reset { background: #6c757d; margin-top: 20px; width: 100%; padding: 10px; }

    </style>
</head>
<body>

    <h3>ğŸ“š ç”Ÿå­—æƒææ©Ÿ V6</h3>
    <div id="system-status">ç³»çµ±æº–å‚™å°±ç·’ (Tesseract Waiting)</div>

    <div class="upload-btn-wrapper" id="upload-wrapper">
        <div class="btn-style" id="btn-text">
            <span>ğŸ“¸</span>
            <span>é»æ­¤æ‹ç…§ / é¸ç…§ç‰‡</span>
            <span style="font-size:14px; color:#666; margin-top:5px; font-weight:normal;">(æ”¯æ´æ‰€æœ‰æ‰‹æ©Ÿ)</span>
        </div>
        <input type="file" name="myfile" accept="image/*" onchange="handleFiles(this.files)">
    </div>

    <div id="preview-box">
        <div style="color:#28a745; font-weight:bold; margin-bottom:5px;">åœ–ç‰‡è®€å–æˆåŠŸï¼</div>
        <img id="preview-img">
        <div id="progress-text" style="margin-top:10px; color:#d35400; font-weight:bold;">â³ æº–å‚™è¾¨è­˜...</div>
    </div>

    <div id="candidates-area">
        <p>ğŸ¤” è«‹é»é¸æ­£ç¢ºçš„å­—ï¼š</p>
        <div id="c-list"></div>
    </div>

    <div id="result-area">
        <div>æ‚¨é¸æ“‡äº†ï¼š</div>
        <div id="final-char" class="big-text">?</div>
        <div>
            <button class="action btn-speak" onclick="speak()">ğŸ”Š ç™¼éŸ³</button>
            <button class="action btn-dict" onclick="dict()">ğŸ“– å­—å…¸</button>
        </div>
        <button class="action btn-reset" onclick="location.reload()">ğŸ”„ æƒæä¸‹ä¸€å€‹å­—</button>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        // æª¢æŸ¥ Tesseract æ˜¯å¦è¼‰å…¥
        window.onload = function() {
            if(typeof Tesseract === 'undefined') {
                document.getElementById('system-status').innerText = "âš ï¸ éŒ¯èª¤ï¼šè¾¨è­˜æ ¸å¿ƒæœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
                document.getElementById('system-status').style.background = "#f8d7da";
                document.getElementById('system-status').style.color = "#721c24";
            }
        };

        const previewBox = document.getElementById('preview-box');
        const previewImg = document.getElementById('preview-img');
        const progressText = document.getElementById('progress-text');
        const candidatesArea = document.getElementById('candidates-area');
        const cList = document.getElementById('c-list');
        const resultArea = document.getElementById('result-area');
        const finalCharDiv = document.getElementById('final-char');
        const canvas = document.getElementById('canvas');
        let selectedChar = "";

        function handleFiles(files) {
            if (files.length === 0) return;

            // UI æ›´æ–°
            document.getElementById('upload-wrapper').style.display = 'none'; // éš±è—æ‹ç…§æŒ‰éˆ•
            previewBox.style.display = 'block';
            progressText.innerText = "â³ æ­£åœ¨è™•ç†åœ–ç‰‡...";

            const file = files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    previewImg.src = e.target.result;
                    // é–‹å§‹è¾¨è­˜æµç¨‹
                    recognizeImage(img);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function recognizeImage(imgElement) {
            progressText.innerText = "ğŸ” æ­£åœ¨åŠªåŠ›è¾¨è­˜æ–‡å­— (ç´„éœ€ 3-5 ç§’)...";
            
            // ç¸®åœ–å„ªåŒ– (é‡è¦ï¼šåŠ é€Ÿç”¨)
            const ctx = canvas.getContext('2d');
            const MAX_W = 800;
            let w = imgElement.width;
            let h = imgElement.height;
            
            if (w > MAX_W) {
                h *= MAX_W / w;
                w = MAX_W;
            }
            canvas.width = w;
            canvas.height = h;
            ctx.drawImage(imgElement, 0, 0, w, h);

            // Tesseract åŸ·è¡Œ
            Tesseract.recognize(
                canvas,
                'chi_tra',
                { logger: m => console.log(m) }
            ).then(({ data: { text } }) => {
                progressText.style.display = 'none';
                
                // ç¯©é¸ä¸­æ–‡å­—
                let chars = text.match(/[\u4e00-\u9fa5]/g);
                if(chars && chars.length > 0) {
                    let unique = [...new Set(chars)];
                    showCandidates(unique.slice(0, 8));
                } else {
                    alert("âŒ æ²’çœ‹åˆ°ä¸­æ–‡å­—è€¶ï¼è«‹é‡æ–°æ‹ç…§ï¼Œå­—è¦å¤§ä¸€é»å–”ã€‚");
                    location.reload();
                }
            }).catch(err => {
                alert("âŒ ç³»çµ±å‡ºéŒ¯ï¼š" + err);
                location.reload();
            });
        }

        function showCandidates(chars) {
            cList.innerHTML = "";
            candidatesArea.style.display = "block";
            chars.forEach(char => {
                let btn = document.createElement("div");
                btn.className = "c-btn";
                btn.innerText = char;
                btn.onclick = function() { showResult(char); };
                cList.appendChild(btn);
            });
        }

        function showResult(char) {
            selectedChar = char;
            candidatesArea.style.display = "none";
            resultArea.style.display = "block";
            finalCharDiv.innerText = char;
            speak();
        }

        function speak() {
            if(!selectedChar) return;
            let u = new SpeechSynthesisUtterance(selectedChar);
            u.lang = 'zh-TW';
            speechSynthesis.speak(u);
        }

        function dict() {
            if(!selectedChar) return;
            window.open(`https://www.moedict.tw/${selectedChar}`, '_blank');
        }
    </script>
</body>
</html>
