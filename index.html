<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”Ÿå­—æƒææ©Ÿ v4.0</title>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <style>
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; text-align: center; background-color: #f0f2f5; padding: 10px; margin: 0;}
        
        /* æ¨™é¡Œ */
        h3 { color: #333; margin: 15px 0; }

        /* æç¤ºèˆ‡éŒ¯èª¤è¨Šæ¯å€ */
        #status-msg { 
            padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 14px; display: none;
        }
        .msg-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .msg-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        /* é¡é ­å€åŸŸ */
        .camera-box {
            position: relative;
            width: 95%; max-width: 400px; height: 300px;
            margin: 0 auto;
            background-color: #000;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
            border: 4px solid #ddd;
        }

        video { 
            width: 100%; height: 100%; object-fit: cover; 
        }

        /* å•Ÿå‹•ç›¸æ©Ÿçš„é®ç½©å±¤ */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #333;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10; color: white;
        }

        /* æƒæç‰¹æ•ˆï¼šç´…è‰²é‚Šæ¡† */
        .scanning-border {
            border-color: #ff3b30 !important;
            box-shadow: 0 0 15px rgba(255, 59, 48, 0.6);
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        button { font-size: 18px; padding: 12px; margin: 10px 5px; border-radius: 30px; border: none; cursor: pointer; width: 85%; max-width: 300px; }
        
        .btn-start { background-color: #28a745; color: white; font-weight: bold; font-size: 20px; }
        .btn-scan { background-color: #007bff; color: white; font-weight: bold; font-size: 20px; box-shadow: 0 4px 0 #0056b3; }
        .btn-scan:disabled { background-color: #ccc; box-shadow: none; color: #666; }
        
        /* å€™é¸å­—èˆ‡çµæœ */
        .candidate-btn {
            display: inline-block; width: 50px; height: 50px; line-height: 50px; margin: 5px;
            background: white; color: #333; font-size: 24px; font-weight: bold;
            border: 2px solid #007bff; border-radius: 10px; padding: 0;
        }
        #result-area { display: none; margin-top: 15px; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .action-group { display: flex; justify-content: center; gap: 10px; }
        .action-btn { width: 45%; font-size: 16px; margin: 5px 0; color: white; }
    </style>
</head>
<body>

    <h3>ğŸ“š ç”Ÿå­—æƒææ©Ÿ v4.0</h3>
    
    <div id="status-msg"></div>

    <div class="camera-box" id="cameraBox">
        <video id="video" playsinline></video>
        
        <div id="start-overlay">
            <p>æº–å‚™å¥½äº†å—ï¼Ÿ</p>
            <button class="btn-start" onclick="startCamera()">ğŸŸ¢ å•Ÿå‹•ç›¸æ©Ÿ</button>
        </div>
    </div>
    <canvas id="canvas" style="display:none;"></canvas>

    <div style="margin-top: 15px;">
        <button id="btnScan" class="btn-scan" onclick="snapAndRecognize()" disabled>ğŸ“¸ æ‹ç…§è¾¨è­˜</button>
    </div>

    <div id="candidates-area" style="display:none; margin-top:10px;">
        <p style="color:#007bff; margin:5px;">ğŸ‘‡ è«‹é»é¸æ­£ç¢ºçš„å­—ï¼š</p>
        <div id="candidate-list"></div>
        <button onclick="resetScanner()" style="background:#eee; color:#555; font-size:14px; width:auto; padding: 8px 20px; margin-top:10px;">ğŸ”„ é‡æ‹</button>
    </div>

    <div id="result-area">
        <div style="font-size:14px; color:#888;">æ‚¨é¸æ“‡äº†ï¼š</div>
        <div id="selected-char" style="font-size:80px; color:#d32f2f; font-weight:bold; line-height: 1.2;">?</div>
        
        <div class="action-group">
            <button class="action-btn" style="background:#28a745;" onclick="speakText()">ğŸ”Š è½ç™¼éŸ³</button>
            <button class="action-btn" style="background:#ff9800;" onclick="openDict()">ğŸ“– æŸ¥å­—å…¸</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startOverlay = document.getElementById('start-overlay');
        const btnScan = document.getElementById('btnScan');
        const cameraBox = document.getElementById('cameraBox');
        const statusMsg = document.getElementById('status-msg');
        const candidatesArea = document.getElementById('candidates-area');
        const candidateList = document.getElementById('candidate-list');
        const resultArea = document.getElementById('result-area');
        
        let streamObj = null;
        let finalChar = "";

        // é¡¯ç¤ºè¨Šæ¯è¼”åŠ©å‡½å¼
        function showMsg(text, type) {
            statusMsg.innerText = text;
            statusMsg.className = type === 'error' ? 'msg-error' : 'msg-info';
            statusMsg.style.display = 'block';
        }

        // 1. æ‰‹å‹•å•Ÿå‹•ç›¸æ©Ÿ (é€™æ˜¯æœ€é—œéµçš„ä¿®æ”¹)
        async function startCamera() {
            showMsg("æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...", "info");
            
            // å˜—è©¦ä¸åŒçš„ç›¸æ©Ÿè¨­å®šï¼Œå…ˆè©¦å¾Œé¡é ­ï¼Œå¤±æ•—å‰‡è©¦ä»»ä½•é¡é ­
            const constraints = { 
                video: { 
                    facingMode: "environment",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            };

            try {
                streamObj = await navigator.mediaDevices.getUserMedia(constraints);
                handleSuccess(streamObj);
            } catch (err) {
                console.error("ç¬¬ä¸€æ¬¡å˜—è©¦å¤±æ•—", err);
                // å¦‚æœå¾Œé¡é ­å¤±æ•—ï¼Œå˜—è©¦æ”¾å¯¬æ¢ä»¶ï¼ˆæœ‰äº›èˆŠå¹³æ¿ä¸æ”¯æ´ environment åƒæ•¸ï¼‰
                try {
                    streamObj = await navigator.mediaDevices.getUserMedia({ video: true });
                    handleSuccess(streamObj);
                } catch (err2) {
                    handleError(err2);
                }
            }
        }

        function handleSuccess(stream) {
            video.srcObject = stream;
            video.play(); // ç¢ºä¿æ’­æ”¾
            startOverlay.style.display = 'none'; // éš±è—å•Ÿå‹•æŒ‰éˆ•
            btnScan.disabled = false; // å•Ÿç”¨æ‹ç…§æŒ‰éˆ•
            showMsg("ç›¸æ©Ÿå·²å•Ÿå‹•ï¼è«‹å°‡ç”Ÿå­—å……æ»¿ç•«é¢ã€‚", "info");
        }

        function handleError(error) {
            console.error(error);
            let errorText = "âŒ ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼š";
            if (error.name === 'NotAllowedError') {
                errorText += "æ‚¨æ‹’çµ•äº†ç›¸æ©Ÿæ¬Šé™ï¼Œè«‹é‡æ•´ç¶²é ä¸¦å…è¨±ã€‚";
            } else if (error.name === 'NotFoundError') {
                errorText += "æ‰¾ä¸åˆ°ç›¸æ©Ÿè£ç½®ã€‚";
            } else {
                errorText += error.message;
            }
            // LINE ç€è¦½å™¨ç‰¹åˆ¥æç¤º
            if (navigator.userAgent.indexOf("Line") > -1) {
                errorText += "\nâš ï¸ è«‹é»é¸å³ä¸Šè§’ï¼Œä½¿ç”¨ Chrome/Safari é–‹å•Ÿã€‚";
            }
            showMsg(errorText, "error");
        }

        // 2. æ‹ç…§èˆ‡è¾¨è­˜
        function snapAndRecognize() {
            if (!streamObj) return;

            // è¦–è¦ºç‰¹æ•ˆ
            cameraBox.classList.add('scanning-border');
            btnScan.innerText = "â³ è¾¨è­˜ä¸­...";
            btnScan.disabled = true;
            showMsg("æ­£åœ¨åŠªåŠ›çœ‹å­—...è«‹ç¨å€™", "info");
            
            // éš±è—èˆŠçµæœ
            candidatesArea.style.display = 'none';
            resultArea.style.display = 'none';

            // æˆªåœ–
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            // Tesseract è¾¨è­˜
            Tesseract.recognize(
                canvas,
                'chi_tra',
                { logger: m => console.log(m) }
            ).then(({ data: {
