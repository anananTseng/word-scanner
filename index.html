<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”Ÿå­—æƒææ©Ÿ V15 (å…è¨­å®šç‰ˆ)</title>
    <style>
        /* åŸºç¤æ¨£å¼ */
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; text-align: center; background-color: #f4f4f4; padding: 10px; margin: 0; }
        h2 { color: #333; margin: 10px 0; font-size: 24px; }

        /* ç³»çµ±æ—¥èªŒ (é™¤éŒ¯ç”¨) */
        #sys-log {
            background: #222; color: #0f0; font-family: monospace;
            padding: 8px; margin-bottom: 15px; text-align: left; font-size: 11px;
            border-radius: 5px; height: 60px; overflow-y: auto;
            border: 1px solid #555;
        }

        /* å¤§æŒ‰éˆ•å€åŸŸ */
        .main-btn {
            display: block; width: 100%; max-width: 400px; margin: 0 auto;
            position: relative; background: white; overflow: hidden;
            border: 3px dashed #007bff; border-radius: 20px; padding: 30px 10px;
            cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .main-btn:active { background-color: #f0f8ff; transform: scale(0.98); }
        
        /* è¦†è“‹åœ¨æŒ‰éˆ•ä¸Šçš„é€æ˜ input */
        .hidden-input {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer; font-size: 100px;
        }

        /* é è¦½èˆ‡çµæœå€ */
        #workspace { display: none; margin-top: 15px; }
        #preview-img { max-width: 150px; border-radius: 8px; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* å€™é¸å­—æŒ‰éˆ• */
        #char-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px; }
        .char-btn {
            width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
            background: white; border: 2px solid #28a745; border-radius: 12px;
            font-size: 32px; font-weight: bold; color: #333; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        /* ä¾†æºæ¨™è¨˜ */
        .tag { position: absolute; top: -5px; right: -5px; font-size: 10px; padding: 2px 5px; border-radius: 8px; color: white; }
        .tag-cloud { background: #007bff; }
        .tag-local { background: #6c757d; }

        /* æœ€çµ‚çµæœå¡ç‰‡ */
        #final-card {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 999;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .big-font { font-size: 120px; color: #d32f2f; font-weight: bold; font-family: serif; margin: 10px 0; }
        .action-btn {
            padding: 12px 30px; margin: 5px; border-radius: 50px; border: none;
            color: white; font-size: 18px; width: 160px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .btn-close { margin-top: 30px; background: transparent; color: #888; border: 1px solid #ccc; font-size: 14px; padding: 8px 20px; border-radius: 20px;}
    </style>
</head>
<body>

    <h2>ğŸš€ ç”Ÿå­—æƒææ©Ÿ V15</h2>

    <div id="sys-log">ç³»çµ±å°±ç·’ï¼Œç­‰å¾…æ‹ç…§...<br></div>

    <div class="main-btn" id="scan-btn">
        <div style="font-size: 40px;">ğŸ“¸</div>
        <div style="font-size: 20px; font-weight: bold;">æ‹ç…§ / é¸ç…§ç‰‡</div>
        <div style="font-size: 14px; color: #666;">(ç›´æ¥é»æ“Šå³å¯)</div>
        <input type="file" class="hidden-input" accept="image/*" onchange="handleFile(this.files)">
    </div>

    <div id="workspace">
        <img id="preview-img">
        <div style="margin-top:10px; color:#007bff; font-weight:bold;">ğŸ‘‡ è¾¨è­˜çµæœï¼š</div>
        <div id="char-list"></div>
        <button onclick="location.reload()" style="margin-top:20px; padding:10px 30px; border-radius:20px; border:none; background:#eee;">ğŸ”„ é‡ä¾†</button>
    </div>

    <div id="final-card">
        <div style="color:#888;">æ‚¨é¸æ“‡äº†ï¼š</div>
        <div id="selected-char" class="big-font">?</div>
        <div>
            <button class="action-btn" style="background:#28a745;" onclick="playAudio()">ğŸ”Š è½ç™¼éŸ³</button>
            <button class="action-btn" style="background:#17a2b8;" onclick="openDict()">ğŸ“– æŸ¥è§£é‡‹</button>
        </div>
        <button class="btn-close" onclick="closeCard()">â†©ï¸ è¿”å›é‡é¸</button>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/2.1.5/tesseract.min.js" onerror="log('âš ï¸ Tesseract è¼‰å…¥å¤±æ•—ï¼Œå°‡åƒ…ä½¿ç”¨é›²ç«¯åŠŸèƒ½')"></script>

    <script>
        // ==================================================
        // â˜…â˜…â˜… è«‹åœ¨é€™è£¡å¡«å…¥æ‚¨çš„ API KEY (ä¿ç•™å¼•è™Ÿ) â˜…â˜…â˜…
        // ä¾‹å¦‚: const MY_KEY = "K81234567889";
        const MY_KEY = "è«‹æŠŠæ‚¨çš„Keyè²¼åœ¨é€™è£¡"; 
        // ==================================================

        // --- å…¨åŸŸè®Šæ•¸ ---
        const logBox = document.getElementById('sys-log');
        const workspace = document.getElementById('workspace');
        const charList = document.getElementById('char-list');
        const previewImg = document.getElementById('preview-img');
        const finalCard = document.getElementById('final-card');
        const selectedCharDiv = document.getElementById('selected-char');
        const canvas = document.getElementById('canvas');
        
        let foundChars = new Set();
        let currentSelection = "";

        function log(msg) {
            console.log(msg);
            logBox.innerHTML += `> ${msg}<br>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        // --- 1. æª”æ¡ˆè™•ç† ---
        function handleFile(files) {
            if(files.length === 0) return;

            // æª¢æŸ¥ä½¿ç”¨è€…æœ‰æ²’æœ‰å¡« Key
            if(MY_KEY === "K83254970588957" || MY_KEY === "") {
                alert("âš ï¸ ç¨‹å¼ç¢¼è£¡çš„ Key é‚„æ²’è¨­å®šå–”ï¼è«‹å›åˆ° GitHub ä¿®æ”¹ index.html");
                log("éŒ¯èª¤: API KEY æœªè¨­å®š");
                return;
            }

            // UI åˆ‡æ›
            document.getElementById('scan-btn').style.display = 'none';
            workspace.style.display = 'block';
            charList.innerHTML = "<div style='color:#888;'>â³ é‹ç®—å•Ÿå‹•ä¸­...</div>";
            foundChars.clear();

            const file = files[0];
            log("è®€å–åœ–ç‰‡...");
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    previewImg.src = e.target.result;
                    startEngines(img);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- 2. å¤šå¼•æ“å•Ÿå‹• ---
        function startEngines(img) {
            const base64 = compressImg(img, 1000);

            // A. æœ¬æ©Ÿ
            if(typeof Tesseract !== 'undefined') {
                log("å•Ÿå‹•æœ¬æ©Ÿå¼•æ“...");
                runLocal(img);
            } else {
                log("è·³éæœ¬æ©Ÿå¼•æ“ (æœªè¼‰å…¥)");
            }

            // B. é›²ç«¯ (å¸¶å…¥ MY_KEY)
            log("å•Ÿå‹•é›²ç«¯æ‰‹å¯«å¼•æ“...");
            runCloud(base64, '2', 'cloud-hand');

            setTimeout(() => {
                log("å•Ÿå‹•é›²ç«¯å°åˆ·å¼•æ“...");
                runCloud(base64, '1', 'cloud-print');
            }, 1200);
        }

        // --- 3. æœ¬æ©Ÿè¾¨è­˜ ---
        function runLocal(img) {
            const ctx = canvas.getContext('2d');
            canvas.width = img.width; canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            Tesseract.recognize(canvas, 'chi_tra')
                .then(({ data: { text } }) => {
                    log("æœ¬æ©Ÿè¾¨è­˜å®Œæˆ");
                    parseText(text, 'local');
                })
                .catch(err => log("âŒ æœ¬æ©ŸéŒ¯èª¤: " + err.message));
        }

        // --- 4. é›²ç«¯è¾¨è­˜ ---
        function runCloud(base64, engineId, sourceTag) {
            const formData = new FormData();
            formData.append("base64Image", base64);
            formData.append("language", "cht");
            formData.append("OCREngine", engineId);
            formData.append("isOverlayRequired", "false");
            formData.append("apikey", MY_KEY); // ä½¿ç”¨ç¨‹å¼ç¢¼ä¸­çš„ Key

            fetch("https://api.ocr.space/parse/image", {
                method: "POST", body: formData
            })
            .then(res => res.json())
            .then(data => {
                if(data.IsErroredOnProcessing) {
                    log(`âŒ é›²ç«¯(${engineId})éŒ¯èª¤: ${data.ErrorMessage}`);
                } else if (data.ParsedResults && data.ParsedResults.length > 0) {
                    log(`âœ… é›²ç«¯(${engineId}) å›å‚³æˆåŠŸ`);
                    parseText(data.ParsedResults[0].ParsedText, 'cloud');
                }
            })
            .catch(err => log(`âŒ é›²ç«¯é€£ç·šå¤±æ•—: ${err}`));
        }

        // --- 5. è§£æèˆ‡é¡¯ç¤º ---
        function parseText(text, type) {
            if(charList.innerHTML.includes('é‹ç®—')) charList.innerHTML = "";

            const matches = text.match(/[\u4e00-\u9fa5]/g);
            if(!matches) return;

            let newCount = 0;
            matches.forEach(char => {
                if(!foundChars.has(char)) {
                    foundChars.add(char);
                    newCount++;
                    createBtn(char, type);
                }
            });
            
            if(newCount > 0) log(`+ æ–°å¢ ${newCount} å­— (${type})`);
        }

        function createBtn(char, type) {
            const btn = document.createElement('div');
            btn.className = 'char-btn';
            btn.innerText = char;
            
            const tag = document.createElement('span');
            tag.className = `tag ${type === 'cloud' ? 'tag-cloud' : 'tag-local'}`;
            tag.innerText = type === 'cloud' ? 'â˜ï¸' : 'ğŸ“±';
            
            btn.appendChild(tag);
            btn.onclick = () => showFinal(char);
            charList.appendChild(btn);
        }

        // --- 6. äº’å‹• ---
        function showFinal(char) {
            currentSelection = char;
            selectedCharDiv.innerText = char;
            finalCard.style.display = 'flex';
            setTimeout(playAudio, 300);
        }

        function closeCard() {
            finalCard.style.display = 'none';
        }

        function playAudio() {
            if(!currentSelection) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(currentSelection);
            u.lang = 'zh-TW';
            
            const voices = window.speechSynthesis.getVoices();
            const zh = voices.find(v => v.lang.includes('zh') || v.lang.includes('TW'));
            if(zh) u.voice = zh;
            
            window.speechSynthesis.speak(u);
        }

        function openDict() {
            if(currentSelection) window.open(`https://www.moedict.tw/${currentSelection}`, '_blank');
        }

        function compressImg(img, maxW) {
            const ctx = canvas.getContext('2d');
            let w = img.width; let h = img.height;
            if(w > maxW) { h *= maxW/w; w = maxW; }
            canvas.width = w; canvas.height = h;
            ctx.drawImage(img, 0, 0, w, h);
            return canvas.toDataURL('image/jpeg', 0.7);
        }
    </script>
</body>
</html>
