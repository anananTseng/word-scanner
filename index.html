<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”Ÿå­—æƒææ©Ÿ V7 (å½±åƒå¢å¼·ç‰ˆ)</title>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; text-align: center; background-color: #f0f4f8; padding: 15px; margin: 0; }
        
        h2 { color: #2c3e50; margin-bottom: 10px; }
        
        /* èªªæ˜æ–‡å­—å€ */
        .guide-text { 
            background: #fff; padding: 10px; border-radius: 10px; 
            font-size: 14px; color: #555; margin-bottom: 15px; text-align: left;
            border-left: 5px solid #007bff; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* ä¸Šå‚³æŒ‰éˆ•ç¾åŒ– */
        .upload-btn-wrapper {
            position: relative; overflow: hidden; display: inline-block; width: 100%; max-width: 400px;
        }
        .upload-btn-wrapper input[type=file] {
            font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
        }
        .btn-style {
            border: 3px dashed #007bff; background-color: #eeffff; color: #0056b3;
            padding: 40px 20px; border-radius: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .btn-style:active { background-color: #b3e5fc; transform: scale(0.98); }
        .icon-camera { font-size: 40px; margin-bottom: 10px; }
        .btn-title { font-size: 22px; font-weight: bold; }
        .btn-desc { font-size: 14px; color: #666; margin-top: 5px; }

        /* é è¦½èˆ‡è™•ç†å€ */
        #process-area { display: none; margin-top: 20px; background: white; padding: 10px; border-radius: 10px; }
        /* æˆ‘å€‘æŠŠåŸæœ¬çš„åœ–ç‰‡ç¸®å°é¡¯ç¤ºï¼ŒæŠŠè™•ç†éçš„é»‘ç™½åœ–ç‰‡é¡¯ç¤ºå‡ºä¾†è®“ä½¿ç”¨è€…çŸ¥é“ç³»çµ±æœ‰åœ¨å·¥ä½œ */
        canvas { max-width: 100%; border: 2px solid #333; border-radius: 5px; margin-top: 10px; }
        
        /* ç‹€æ…‹æ–‡å­— */
        #status-text { font-weight: bold; color: #d35400; margin: 10px 0; }

        /* å€™é¸å­—å€ */
        #candidates-area { display: none; margin-top: 15px; padding: 15px; background: #fff; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .c-btn {
            display: inline-block; width: 55px; height: 55px; line-height: 55px; margin: 5px;
            background: #fff; border: 2px solid #007bff; border-radius: 12px;
            font-size: 28px; color: #333; cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .c-btn:active { background: #007bff; color: white; }

        /* çµæœå€ */
        #result-area { display: none; margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 15px; border: 2px solid #ffeeba; }
        .big-text { font-size: 90px; color: #c0392b; margin: 10px 0; font-weight: bold; font-family: "KaiTi", "BiauKai", serif; } /* ç”¨æ¥·é«”é¡¯ç¤ºæ›´åƒç”Ÿå­— */
        
        .action-btn { 
            font-size: 18px; padding: 12px 25px; margin: 5px; border: none; border-radius: 50px; color: white; cursor: pointer; width: 40%; 
            box-shadow: 0 3px 0 rgba(0,0,0,0.1);
        }
        .btn-speak { background: #27ae60; }
        .btn-dict { background: #2980b9; }
        .btn-reset { background: #95a5a6; width: 90%; margin-top: 15px; }

    </style>
</head>
<body>

    <h2>ğŸ“ ç”Ÿå­—æƒææ©Ÿ V7</h2>
    
    <div class="guide-text">
        <strong>ğŸ’¡ ä½¿ç”¨å°æ’‡æ­¥ï¼š</strong><br>
        1. å»ºè­°å…ˆç”¨æ‰‹æ©Ÿç›¸æ©Ÿæ‹å¥½ç…§ç‰‡ï¼Œç¢ºèªå­—é«”æ¸…æ¥šã€‚<br>
        2. é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œå¾ç›¸ç°¿é¸æ“‡è©²ç…§ç‰‡ã€‚<br>
        3. ç³»çµ±æœƒè‡ªå‹•å°‡åœ–ç‰‡è½‰ç‚ºé»‘ç™½ä»¥æå‡è¾¨è­˜ç‡ã€‚
    </div>

    <div class="upload-btn-wrapper" id="upload-wrapper">
        <div class="btn-style">
            <div class="icon-camera">ğŸ“¸</div>
            <div class="btn-title">æ‹ç…§ æˆ– é¸å–ç…§ç‰‡</div>
            <div class="btn-desc">ç³»çµ±æœƒè‡ªå‹•åŠ å¼·æ–‡å­—æ¸…æ™°åº¦</div>
        </div>
        <input type="file" accept="image/*" onchange="handleFiles(this.files)">
    </div>

    <div id="process-area">
        <div id="status-text">â³ æ­£åœ¨è®€å–åœ–ç‰‡...</div>
        <div style="font-size:12px; color:#999;">å½±åƒå¢å¼·é è¦½ï¼š</div>
        <canvas id="process-canvas"></canvas>
    </div>

    <div id="candidates-area">
        <p style="color:#007bff; margin:0 0 10px 0;">ğŸ‘‡ ç³»çµ±çœ‹åˆ°é€™äº›å­—ï¼Œè«‹é¸æ­£ç¢ºçš„ï¼š</p>
        <div id="c-list"></div>
    </div>

    <div id="result-area">
        <div style="color:#7f8c8d;">æ‚¨é¸æ“‡äº†ï¼š</div>
        <div id="final-char" class="big-text">?</div>
        <div>
            <button class="action-btn btn-speak" onclick="speak()">ğŸ”Š è½è®€éŸ³</button>
            <button class="action-btn btn-dict" onclick="dict()">ğŸ“– æŸ¥è§£é‡‹</button>
        </div>
        <button class="action-btn btn-reset" onclick="location.reload()">ğŸ”„ æƒæä¸‹ä¸€å€‹</button>
    </div>

    <script>
        const uploadWrapper = document.getElementById('upload-wrapper');
        const processArea = document.getElementById('process-area');
        const statusText = document.getElementById('status-text');
        const canvas = document.getElementById('process-canvas');
        const cList = document.getElementById('c-list');
        const candidatesArea = document.getElementById('candidates-area');
        const resultArea = document.getElementById('result-area');
        const finalCharDiv = document.getElementById('final-char');
        
        let selectedChar = "";

        function handleFiles(files) {
            if (files.length === 0) return;

            uploadWrapper.style.display = 'none';
            processArea.style.display = 'block';
            
            const file = files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // é€²å…¥å½±åƒè™•ç†æµç¨‹
                    processAndRecognize(img);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // æ ¸å¿ƒå‡ç´šï¼šå½±åƒå‰è™•ç† (Pre-processing)
        function processAndRecognize(img) {
            statusText.innerText = "ğŸ”§ æ­£åœ¨é€²è¡Œå½±åƒå¢å¼·è™•ç†...";
            
            const ctx = canvas.getContext('2d');
            
            // 1. ç¸®æ”¾åœ–ç‰‡ (å¤ªå¤§çš„åœ–ç‰‡è¾¨è­˜æ…¢ï¼Œå¤ªå°ä¸æº–ï¼Œè¨­å¯¬åº¦ 800 ç‚ºä½³)
            const MAX_W = 800;
            let w = img.width;
            let h = img.height;
            if (w > MAX_W) { h *= MAX_W / w; w = MAX_W; }
            
            canvas.width = w;
            canvas.height = h;
            ctx.drawImage(img, 0, 0, w, h);

            // 2. å–å¾—åƒç´ è³‡æ–™
            let imageData = ctx.getImageData(0, 0, w, h);
            let data = imageData.data;

            // 3. äºŒå€¼åŒ–æ¼”ç®—æ³• (Binarization) - æŠŠç°è‰²è®Šé»‘è‰²ï¼ŒèƒŒæ™¯è®Šå…¨ç™½
            // é€™æ˜¯æå‡æ‰‹å¯«è¾¨è­˜ç‡çš„é—œéµï¼
            for (let i = 0; i < data.length; i += 4) {
                // è¨ˆç®—ç°åº¦ (R+G+B)/3
                let avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                // é–¥å€¼è¨­å®šç‚º 160 (å¯èª¿æ•´)ï¼Œä½æ–¼æ­¤å€¼è®Šé»‘(å­—)ï¼Œé«˜æ–¼æ­¤å€¼è®Šç™½(ç´™)
                let threshold = 160; 
                let color = avg < threshold ? 0 : 255;
                
                data[i] = color;     // R
                data[i + 1] = color; // G
                data[i + 2] = color; // B
            }
            
            // å°‡è™•ç†å¥½çš„é»‘ç™½åœ–ç‰‡æ”¾å› Canvas
            ctx.putImageData(imageData, 0, 0);

            // 4. é–‹å§‹è¾¨è­˜ (å‚³é€è™•ç†éçš„ Canvas çµ¦ Tesseract)
            statusText.innerText = "ğŸ” æ­£åœ¨åŠªåŠ›è¾¨è­˜æ–‡å­—...";
            
            Tesseract.recognize(
                canvas, // é€™è£¡å‚³é€çš„æ˜¯é»‘ç™½åœ–ç‰‡
                'chi_tra',
                { logger: m => console.log(m) }
            ).then(({ data: { text } }) => {
                statusText.style.display = 'none';
                
                // éæ¿¾èˆ‡å»é‡
                let chars = text.match(/[\u4e00-\u9fa5]/g);
                
                if(chars && chars.length > 0) {
                    // éæ¿¾æ‰å¤ªéæ–¼å¥‡æ€ªçš„è¾¨è­˜çµæœï¼Œä¸¦å–å‰ 10 å€‹
                    let unique = [...new Set(chars)].slice(0, 10);
                    showCandidates(unique);
                } else {
                    alert("âŒ å—šå—šï¼Œçœ‹ä¸æ‡‚é€™å€‹å­—...\nå»ºè­°ï¼š\n1.å­—å¯«å¤§ä¸€é»\n2.ç­†ç•«ç²—ä¸€é»\n3.ç›¡é‡åªæœ‰ä¸€å€‹å­—åœ¨ç•«é¢ä¸­");
                    location.reload();
                }
            }).catch(err => {
                alert("ç³»çµ±éŒ¯èª¤ï¼š" + err);
                location.reload();
            });
        }

        function showCandidates(chars) {
            cList.innerHTML = "";
            candidatesArea.style.display = "block";
            // è‡ªå‹•æ²å‹•
            candidatesArea.scrollIntoView({ behavior: 'smooth' });

            chars.forEach(char => {
                let btn = document.createElement("div");
                btn.className = "c-btn";
                btn.innerText = char;
                btn.onclick = function() { showResult(char); };
                cList.appendChild(btn);
            });
        }

        function showResult(char) {
            selectedChar = char;
            candidatesArea.style.display = "none";
            processArea.style.display = "none"; // éš±è—é»‘ç™½åœ–
            resultArea.style.display = "block";
            finalCharDiv.innerText = char;
            speak();
        }

        function speak() {
            if(!selectedChar) return;
            let u = new SpeechSynthesisUtterance(selectedChar);
            u.lang = 'zh-TW';
            speechSynthesis.speak(u);
        }

        function dict() {
            if(!selectedChar) return;
            window.open(`https://www.moedict.tw/${selectedChar}`, '_blank');
        }
    </script>
</body>
</html>
