<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”Ÿå­—æƒææ©Ÿ V11 (ç©©å®šæ•´åˆç‰ˆ)</title>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <style>
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; text-align: center; background-color: #f8f9fa; padding: 15px; margin: 0; }
        h2 { color: #333; margin: 10px 0; }

        /* ç³»çµ±æ—¥èªŒ (é—œéµï¼šè®“ä½ çŸ¥é“ç™¼ç”Ÿä»€éº¼äº‹) */
        #log-area {
            background: #333; color: #0f0; font-family: monospace;
            padding: 10px; border-radius: 8px; margin-bottom: 15px;
            text-align: left; font-size: 12px; min-height: 60px;
            overflow-y: auto; max-height: 100px;
            border: 2px solid #555;
        }
        .log-err { color: #ff5555; }
        .log-warn { color: #ffeb3b; }

        /* API Key è¨­å®š */
        #apikey-section {
            background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px;
            border: 1px solid #ffeeba; text-align: left;
        }
        input[type="text"] {
            width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box;
            border: 1px solid #ddd; border-radius: 5px; font-size: 16px;
        }

        /* æ‹ç…§æŒ‰éˆ• */
        .upload-btn-wrapper {
            position: relative; overflow: hidden; display: block; width: 100%; max-width: 400px; margin: 0 auto;
        }
        .upload-btn-wrapper input[type=file] {
            font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
        }
        .btn-style {
            border: 3px dashed #007bff; background-color: white; color: #0056b3;
            padding: 30px 20px; border-radius: 20px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .btn-style:active { background-color: #eef; }

        /* é è¦½åœ–ç‰‡ */
        #preview-container { display: none; margin-top: 15px; }
        #preview-img { max-width: 150px; border-radius: 5px; border: 1px solid #ccc; }

        /* çµ±ä¸€å€™é¸å­—å€ (æœ€é‡è¦çš„çµæœå€) */
        #candidates-area { display: none; margin-top: 20px; padding: 10px; background: white; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #c-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        
        .c-btn {
            width: 60px; height: 60px; line-height: 60px;
            background: #fff; border: 2px solid #28a745; border-radius: 12px;
            font-size: 32px; color: #333; cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        /* æ¨™è¨˜æ˜¯å“ªå€‹å¼•æ“æ‰¾åˆ°çš„ */
        .badge {
            position: absolute; top: -5px; right: -5px;
            font-size: 10px; color: white; padding: 2px 5px; border-radius: 4px;
        }
        .bg-cloud { background: #007bff; }
        .bg-local { background: #6c757d; }

        /* çµæœèˆ‡åŠŸèƒ½ */
        #final-result { display: none; margin-top: 20px; background: #e8f5e9; padding: 20px; border-radius: 15px; border: 2px solid #c8e6c9; }
        .big-char { font-size: 100px; color: #d32f2f; font-weight: bold; font-family: "KaiTi", serif; line-height: 1.2; }
        
        .action-btn { 
            font-size: 18px; padding: 10px 20px; margin: 5px; border: none; border-radius: 50px; color: white; cursor: pointer; 
        }
    </style>
</head>
<body>

    <h2>ğŸ” ç”Ÿå­—æƒææ©Ÿ V11</h2>

    <div id="log-area">ç³»çµ±æº–å‚™å°±ç·’...<br>ç­‰å¾…æ‹ç…§...</div>

    <div id="apikey-section" style="display:none;">
        <label style="font-weight:bold; color:#856404;">ğŸ”‘ éœ€è¦é›²ç«¯ Key</label>
        <div style="font-size:12px; color:#666;">è«‹è¼¸å…¥ OCR.space Key ä»¥å•Ÿç”¨é›²ç«¯å¼·åŠ›è¾¨è­˜</div>
        <input type="text" id="api-key-input" placeholder="è²¼ä¸Š Key" onchange="saveKey()">
    </div>

    <div class="upload-btn-wrapper" id="upload-wrapper">
        <div class="btn-style">
            <div style="font-size: 30px;">ğŸ“¸</div>
            <div style="font-size: 18px; font-weight: bold; margin-top: 5px;">æ‹ç…§ / é¸åœ–</div>
            <div style="font-size: 12px; color: #888;">(æ•´åˆä¸‰æ ¸å¿ƒé‹ç®—)</div>
        </div>
        <input type="file" accept="image/*" onchange="handleFiles(this.files)">
    </div>

    <div id="preview-container">
        <img id="preview-img">
    </div>

    <div id="candidates-area">
        <p style="margin:0 0 10px 0; font-weight:bold; color:#007bff;">ğŸ‘‡ è«‹é»é¸æ­£ç¢ºçš„å­—ï¼š</p>
        <div id="c-list"></div>
        <button onclick="location.reload()" style="margin-top:20px; background:#eee; border:none; padding:8px 20px; border-radius:20px;">ğŸ”„ é‡æ‹</button>
    </div>

    <div id="final-result">
        <div>æ‚¨é¸æ“‡äº†ï¼š</div>
        <div id="selected-char" class="big-char">?</div>
        <div>
            <button class="action-btn" style="background:#28a745;" onclick="speak()">ğŸ”Š ç™¼éŸ³</button>
            <button class="action-btn" style="background:#17a2b8;" onclick="dict()">ğŸ“– è§£é‡‹</button>
        </div>
    </div>

    <canvas id="process-canvas" style="display:none;"></canvas>

    <script>
        const logArea = document.getElementById('log-area');
        const apiKeySection = document.getElementById('apikey-section');
        const apiKeyInput = document.getElementById('api-key-input');
        const candidatesArea = document.getElementById('candidates-area');
        const cList = document.getElementById('c-list');
        const finalResult = document.getElementById('final-result');
        const selectedCharDiv = document.getElementById('selected-char');
        const canvas = document.getElementById('process-canvas');
        const previewImg = document.getElementById('preview-img');

        let foundChars = new Set(); // ç”¨ä¾†å„²å­˜æ‰€æœ‰æ‰¾åˆ°çš„å­— (é¿å…é‡è¤‡)
        let selectedChar = "";

        // å¯«æ—¥èªŒåŠŸèƒ½
        function log(msg, type="info") {
            const span = document.createElement('div');
            span.innerHTML = `> ${msg}`;
            if(type === 'error') span.className = 'log-err';
            logArea.appendChild(span);
            logArea.scrollTop = logArea.scrollHeight; // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            const key = localStorage.getItem('ocr_api_key');
            if(key) {
                apiKeyInput.value = key;
                log("å·²è®€å– API Key: " + key.substring(0,4) + "****");
            } else {
                log("âš ï¸ æœªåµæ¸¬åˆ° API Keyï¼Œè«‹å…ˆè¼¸å…¥", "warn");
                apiKeySection.style.display = 'block';
            }
        }

        function saveKey() {
            const key = apiKeyInput.value.trim();
            if(key) {
                localStorage.setItem('ocr_api_key', key);
                log("âœ… Key å·²å„²å­˜ï¼");
                apiKeySection.style.display = 'none';
            }
        }

        // è™•ç†æª”æ¡ˆ
        function handleFiles(files) {
            if(files.length === 0) return;

            const key = localStorage.getItem('ocr_api_key');
            if(!key) {
                alert("è«‹å…ˆè¼¸å…¥ API Key å–”ï¼");
                apiKeySection.style.display = 'block';
                return;
            }

            // UI é‡ç½®
            document.getElementById('upload-wrapper').style.display = 'none';
            document.getElementById('preview-container').style.display = 'block';
            candidatesArea.style.display = 'block'; // å…ˆé¡¯ç¤ºå‡ºä¾†ï¼Œä¸ç„¶æœƒè¦ºå¾—æ²’åæ‡‰
            cList.innerHTML = "<div style='color:#888; font-size:14px;'>â³ æ­£åœ¨ç”¨åŠ›è¾¨è­˜ä¸­...</div>";
            foundChars.clear();

            const file = files[0];
            log("è®€å–åœ–ç‰‡ä¸­...");
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    previewImg.src = e.target.result;
                    startRecognition(img, key);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // å•Ÿå‹•æ‰€æœ‰è¾¨è­˜
        function startRecognition(img, key) {
            // 1. æœ¬æ©Ÿ Tesseract
            runLocal(img);

            // 2. é›²ç«¯è¾¨è­˜ (å£“ç¸®åœ–ç‰‡)
            const base64 = compressImage(img, 1000);
            
            // å¹³è¡Œç™¼é€å…©å€‹é›²ç«¯è«‹æ±‚ (Engine 1 å’Œ 2)
            runCloud(base64, key, '2', 'é›²ç«¯æ‰‹å¯«');
            
            // å»¶é²ä¸€é»é»ç™¼é€ç¬¬äºŒå€‹ï¼Œé¿å… API é™åˆ¶
            setTimeout(() => {
                runCloud(base64, key, '1', 'é›²ç«¯å°åˆ·');
            }, 1000);
        }

        // æœ¬æ©Ÿè¾¨è­˜
        function runLocal(img) {
            log("å•Ÿå‹•æœ¬æ©Ÿ Tesseract...");
            const ctx = canvas.getContext('2d');
            canvas.width = img.width; canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            Tesseract.recognize(canvas, 'chi_tra')
            .then(({ data: { text } }) => {
                log("æœ¬æ©Ÿè¾¨è­˜å®Œæˆ");
                processText(text, 'local');
            })
            .catch(err => log("æœ¬æ©ŸéŒ¯èª¤: " + err, 'error'));
        }

        // é›²ç«¯è¾¨è­˜
        function runCloud(base64, key, engineId, name) {
            log(`å•Ÿå‹•${name} (Engine ${engineId})...`);
            
            const formData = new FormData();
            formData.append("base64Image", base64);
            formData.append("language", "cht");
            formData.append("OCREngine", engineId);
            formData.append("isOverlayRequired", "false");

            fetch("https://api.ocr.space/parse/image", {
                method: "POST", headers: { "apikey": key }, body: formData
            })
            .then(res => res.json())
            .then(data => {
                if(data.IsErroredOnProcessing) {
                    log(`âŒ ${name} å¤±æ•—: ${data.ErrorMessage}`, 'error');
                } else {
                    log(`âœ… ${name} æˆåŠŸå›å‚³`);
                    let text = (data.ParsedResults && data.ParsedResults.length > 0) ? data.ParsedResults[0].ParsedText : "";
                    processText(text, 'cloud');
                }
            })
            .catch(err => log(`âŒ ${name} é€£ç·šéŒ¯èª¤`, 'error'));
        }

        // çµ±ä¸€è™•ç†ä¸¦é¡¯ç¤ºçµæœ
        function processText(text, source) {
            // æ¸…é™¤ã€Œæ­£åœ¨è¾¨è­˜ä¸­ã€çš„å­—æ¨£
            const loadingMsg = cList.querySelector('div');
            if(loadingMsg && loadingMsg.innerText.includes('è¾¨è­˜ä¸­')) {
                cList.innerHTML = "";
            }

            // æŠ“å–ä¸­æ–‡
            let chars = text.match(/[\u4e00-\u9fa5]/g);
            if(!chars) return;

            let newCount = 0;
            chars.forEach(char => {
                if(!foundChars.has(char)) {
                    foundChars.add(char);
                    addCharButton(char, source);
                    newCount++;
                }
            });

            if(newCount > 0) {
                log(`> æ–°å¢äº† ${newCount} å€‹å€™é¸å­—`);
            }
        }

        function addCharButton(char, source) {
            let btn = document.createElement("div");
            btn.className = "c-btn";
            btn.innerText = char;
            
            // æ¨™ç±¤ (åˆ†è¾¨æ˜¯é›²ç«¯é‚„æ˜¯æœ¬æ©Ÿæ‰¾åˆ°çš„)
            let badge = document.createElement("span");
            badge.className = "badge " + (source === 'cloud' ? 'bg-cloud' : 'bg-local');
            badge.innerText = source === 'cloud' ? 'â˜ï¸' : 'ğŸ“±';
            btn.appendChild(badge);

            btn.onclick = function() { showFinal(char); };
            cList.appendChild(btn);
        }

        function compressImage(img, maxWidth) {
            const ctx = canvas.getContext('2d');
            let w = img.width; let h = img.height;
            if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
            canvas.width = w; canvas.height = h;
            ctx.drawImage(img, 0, 0, w, h);
            return canvas.toDataURL('image/jpeg', 0.7);
        }

        // æœ€çµ‚åŠŸèƒ½
        function showFinal(char) {
            selectedChar = char;
            candidatesArea.style.display = 'none';
            finalResult.style.display = 'block';
            selectedCharDiv.innerText = char;
            speak();
        }

        function speak() {
            if(!selectedChar) return;
            let u = new SpeechSynthesisUtterance(selectedChar);
            u.lang = 'zh-TW';
            speechSynthesis.speak(u);
        }

        function dict() {
            if(!selectedChar) return;
            window.open(`https://www.moedict.tw/${selectedChar}`, '_blank');
        }
    </script>
</body>
</html>
