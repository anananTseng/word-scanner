<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”Ÿå­—æƒææ©Ÿ V9 (å¤šæ ¸å¿ƒç‰ˆ)</title>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <style>
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; text-align: center; background-color: #f0f2f5; padding: 15px; margin: 0; }
        
        /* é¸æ“‡å¼•æ“å€ */
        .engine-selector {
            background: white; padding: 10px; margin-bottom: 15px; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: left;
        }
        select {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd;
            font-size: 16px; background: #fff; margin-top: 5px;
        }

        /* API Key è¨­å®šå€ */
        #apikey-section {
            background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 15px;
            border: 1px solid #ffeeba; text-align: left; display: none;
        }
        input[type="text"] {
            width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box;
            border: 1px solid #ddd; border-radius: 5px; font-size: 16px;
        }

        /* æ‹ç…§æŒ‰éˆ• */
        .upload-btn-wrapper {
            position: relative; overflow: hidden; display: block; width: 100%; max-width: 400px; margin: 0 auto;
        }
        .upload-btn-wrapper input[type=file] {
            font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
        }
        .btn-style {
            border: 3px dashed #007bff; background-color: #eaf6ff; color: #0056b3;
            padding: 35px 20px; border-radius: 20px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center;
        }
        .btn-style:active { transform: scale(0.98); background-color: #d0e9ff; }

        /* é è¦½èˆ‡ç‹€æ…‹ */
        #preview-area { display: none; margin-top: 20px; }
        #preview-img { max-width: 250px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #status-text { font-weight: bold; color: #d35400; margin: 15px 0; font-size: 18px; }

        /* å€™é¸å­—å€ */
        #candidates-area { display: none; margin-top: 15px; padding: 15px; background: #fff; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .c-btn {
            display: inline-block; width: 60px; height: 60px; line-height: 60px; margin: 6px;
            background: #fff; border: 2px solid #28a745; border-radius: 12px;
            font-size: 30px; color: #333; cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .c-btn:hover { background-color: #e8f5e9; }

        /* çµæœå€ */
        #result-area { display: none; margin-top: 20px; padding: 20px; background: #fff; border-radius: 15px; border-top: 5px solid #28a745; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .big-text { font-size: 100px; color: #c0392b; margin: 5px 0; font-weight: bold; font-family: "KaiTi", serif; line-height: 1.2; }
        
        .action-btn { 
            font-size: 18px; padding: 12px 20px; margin: 5px; border: none; border-radius: 50px; color: white; cursor: pointer; width: 45%; 
        }
    </style>
</head>
<body>

    <h2 style="margin:10px 0;">ğŸ§  ç”Ÿå­—æƒææ©Ÿ V9</h2>

    <div class="engine-selector">
        <label style="font-weight:bold; color:#333;">âš™ï¸ è«‹é¸æ“‡è¾¨è­˜å¤§è…¦ï¼š</label>
        <select id="engine-select" onchange="checkEngine()">
            <option value="cloud_2" selected>â˜ï¸ é›²ç«¯å¤§è…¦ï¼šæ‰‹å¯«å¼·é … (æ¨è–¦)</option>
            <option value="cloud_1">â˜ï¸ é›²ç«¯å¤§è…¦ï¼šå°åˆ·æ¨™æº–</option>
            <option value="local">ğŸ“± æœ¬æ©Ÿå¤§è…¦ï¼šTesseract (ä¸éœ€ç¶²è·¯)</option>
        </select>
    </div>

    <div id="apikey-section">
        <label style="font-weight:bold; color:#856404;">ğŸ”‘ è«‹è¼¸å…¥é›²ç«¯é‡‘é‘° (API Key)</label>
        <div style="font-size:12px; color:#856404; margin-bottom:5px;">å› ç‚ºæ‚¨é¸æ“‡äº†é›²ç«¯å¤§è…¦ï¼Œåˆæ¬¡ä½¿ç”¨éœ€è¼¸å…¥ Key (<a href="https://ocr.space/ocrapi/freekey" target="_blank">å…è²»ç”³è«‹é»æˆ‘</a>)</div>
        <input type="text" id="api-key-input" placeholder="è²¼ä¸Š Key å¾Œé»é¸å…¶ä»–ç©ºç™½è™•" onchange="saveKey()">
    </div>

    <div class="upload-btn-wrapper" id="upload-wrapper">
        <div class="btn-style">
            <div style="font-size: 40px;">ğŸ“¸</div>
            <div style="font-size: 20px; font-weight: bold;">æ‹ç…§ / é¸åœ–</div>
            <div style="font-size: 14px; color: #666; margin-top: 5px;">é»æ“Šå•Ÿå‹•ç›¸æ©Ÿ</div>
        </div>
        <input type="file" accept="image/*" onchange="handleFiles(this.files)">
    </div>

    <div id="preview-area">
        <img id="preview-img">
        <div id="status-text"></div>
    </div>

    <div id="candidates-area">
        <p style="color:#28a745; margin:0 0 10px 0; font-weight:bold;">ğŸ‘‡ è¾¨è­˜çµæœ (è«‹é»é¸)ï¼š</p>
        <div id="c-list"></div>
        <button onclick="location.reload()" style="margin-top:15px; background:#eee; border:none; padding:10px 30px; border-radius:20px; color:#555;">ğŸ”„ æ›å€‹å¤§è…¦é‡æ‹</button>
    </div>

    <div id="result-area">
        <div style="color:#7f8c8d;">æ‚¨é¸æ“‡äº†ï¼š</div>
        <div id="final-char" class="big-text">?</div>
        <div>
            <button class="action-btn" style="background:#27ae60;" onclick="speak()">ğŸ”Š ç™¼éŸ³</button>
            <button class="action-btn" style="background:#2980b9;" onclick="dict()">ğŸ“– è§£é‡‹</button>
        </div>
        <button class="action-btn" style="background:#95a5a6; width:90%; margin-top:15px;" onclick="location.reload()">ğŸ”„ ä¸‹ä¸€å€‹å­—</button>
    </div>

    <canvas id="compress-canvas" style="display:none;"></canvas>

    <script>
        const engineSelect = document.getElementById('engine-select');
        const apiKeySection = document.getElementById('apikey-section');
        const apiKeyInput = document.getElementById('api-key-input');
        const statusText = document.getElementById('status-text');
        const previewImg = document.getElementById('preview-img');
        const cList = document.getElementById('c-list');
        const candidatesArea = document.getElementById('candidates-area');
        const resultArea = document.getElementById('result-area');
        const finalCharDiv = document.getElementById('final-char');
        const canvas = document.getElementById('compress-canvas');
        let selectedChar = "";

        // åˆå§‹åŒ–æª¢æŸ¥ Key
        window.onload = function() {
            const savedKey = localStorage.getItem('ocr_api_key');
            if(savedKey) apiKeyInput.value = savedKey;
            checkEngine(); // æ ¹æ“šé è¨­é¸é …æ±ºå®šæ˜¯å¦é¡¯ç¤º Key è¼¸å…¥æ¡†
        }

        function checkEngine() {
            const mode = engineSelect.value;
            const savedKey = localStorage.getItem('ocr_api_key');
            
            if (mode.startsWith('cloud')) {
                // å¦‚æœæ˜¯é›²ç«¯æ¨¡å¼ä¸”æ²’æœ‰å­˜ Keyï¼Œå°±é¡¯ç¤ºè¼¸å…¥æ¡†
                if (!savedKey) {
                    apiKeySection.style.display = 'block';
                } else {
                    apiKeySection.style.display = 'none';
                }
            } else {
                // æœ¬æ©Ÿæ¨¡å¼ä¸éœ€è¦ Key
                apiKeySection.style.display = 'none';
            }
        }

        function saveKey() {
            const key = apiKeyInput.value.trim();
            if(key) {
                localStorage.setItem('ocr_api_key', key);
                alert("Key å·²å„²å­˜ï¼");
                apiKeySection.style.display = 'none';
            }
        }

        function handleFiles(files) {
            if (files.length === 0) return;
            
            const mode = engineSelect.value;
            const key = localStorage.getItem('ocr_api_key');

            // æª¢æŸ¥é›²ç«¯æ¨¡å¼æ˜¯å¦æœ‰ Key
            if (mode.startsWith('cloud') && !key) {
                alert("âš ï¸ è«‹å…ˆè¼¸å…¥é›²ç«¯ Key æ‰èƒ½ä½¿ç”¨æ­¤æ¨¡å¼ï¼");
                apiKeySection.style.display = 'block';
                return;
            }

            // UI åˆ‡æ›
            document.getElementById('upload-wrapper').style.display = 'none';
            document.getElementById('preview-area').style.display = 'block';
            statusText.innerText = "â³ åœ–ç‰‡è™•ç†ä¸­...";

            const file = files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    previewImg.src = e.target.result;
                    
                    if (mode === 'local') {
                        runLocalOCR(img);
                    } else {
                        runCloudOCR(img, key, mode);
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- é›²ç«¯è¾¨è­˜é‚è¼¯ ---
        function runCloudOCR(img, key, mode) {
            const engineID = (mode === 'cloud_2') ? '2' : '1'; // æ±ºå®šç”¨å“ªå€‹å¼•æ“
            statusText.innerText = `â˜ï¸ é›²ç«¯å¼•æ“ ${engineID} é‹ç®—ä¸­...`;

            // å£“ç¸®åœ–ç‰‡
            const base64 = compressImage(img, 1000);

            const formData = new FormData();
            formData.append("base64Image", base64);
            formData.append("language", "cht");
            formData.append("isOverlayRequired", "false");
            formData.append("OCREngine", engineID); // å‹•æ…‹åˆ‡æ›å¼•æ“

            fetch("https://api.ocr.space/parse/image", {
                method: "POST",
                headers: { "apikey": key },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.IsErroredOnProcessing) {
                    statusText.innerText = "âŒ éŒ¯èª¤ï¼š" + data.ErrorMessage;
                    return;
                }
                let allText = (data.ParsedResults && data.ParsedResults.length > 0) ? data.ParsedResults[0].ParsedText : "";
                processResult(allText);
            })
            .catch(err => {
                statusText.innerText = "âŒ é€£ç·šå¤±æ•—ï¼š" + err;
            });
        }

        // --- æœ¬æ©Ÿè¾¨è­˜é‚è¼¯ ---
        function runLocalOCR(img) {
            statusText.innerText = "ğŸ“± æœ¬æ©Ÿ Tesseract é‹ç®—ä¸­...";
            
            const ctx = canvas.getContext('2d');
            // æœ¬æ©Ÿè¾¨è­˜ä¸éœ€è¦å£“ç¸®å¤ªå°ï¼Œä½†ç‚ºäº† Canvas ç¹ªè£½é‚„æ˜¯æ­£è¦åŒ–ä¸€ä¸‹
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            Tesseract.recognize(
                canvas,
                'chi_tra',
                { logger: m => console.log(m) }
            ).then(({ data: { text } }) => {
                processResult(text);
            });
        }

        // --- é€šç”¨çµæœè™•ç† ---
        function processResult(text) {
            // æŠ“å‡ºä¸­æ–‡å­—
            let chars = text.match(/[\u4e00-\u9fa5]/g);
            
            if(chars && chars.length > 0) {
                statusText.style.display = 'none';
                // å–å‰ 10 å€‹ä¸é‡è¤‡çš„å­—
                let unique = [...new Set(chars)].slice(0, 10);
                showCandidates(unique);
            } else {
                statusText.innerText = "âŒ æ²’çœ‹æ‡‚... è«‹è©¦è©¦åˆ‡æ›å¦ä¸€å€‹å¤§è…¦ï¼";
                setTimeout(() => {
                    document.getElementById('upload-wrapper').style.display = 'block';
                }, 2000);
            }
        }

        // åœ–ç‰‡å£“ç¸®å·¥å…·
        function compressImage(img, maxWidth) {
            const ctx = canvas.getContext('2d');
            let w = img.width;
            let h = img.height;
            if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
            canvas.width = w;
            canvas.height = h;
            ctx.drawImage(img, 0, 0, w, h);
            return canvas.toDataURL('image/jpeg', 0.7);
        }

        function showCandidates(chars) {
            cList.innerHTML = "";
            candidatesArea.style.display = "block";
            chars.forEach(char => {
                let btn = document.createElement("div");
                btn.className = "c-btn";
                btn.innerText = char;
                btn.onclick = function() { showResult(char); };
                cList.appendChild(btn);
            });
        }

        function showResult(char) {
            selectedChar = char;
            candidatesArea.style.display = "none";
            resultArea.style.display = "block";
            finalCharDiv.innerText = char;
            speak();
        }

        function speak() {
            if(!selectedChar) return;
            let u = new SpeechSynthesisUtterance(selectedChar);
            u.lang = 'zh-TW';
            speechSynthesis.speak(u);
        }

        function dict() {
            if(!selectedChar) return;
            window.open(`https://www.moedict.tw/${selectedChar}`, '_blank');
        }
    </script>
</body>
</html>
